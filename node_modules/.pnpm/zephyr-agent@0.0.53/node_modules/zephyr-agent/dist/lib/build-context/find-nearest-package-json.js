"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.find_nearest_package_json = find_nearest_package_json;
const node_fs_1 = require("node:fs");
const promises_1 = require("node:fs/promises");
const node_path_1 = require("node:path");
const errors_1 = require("../errors");
const debug_1 = require("../logging/debug");
const max_retry = 30;
async function find_nearest_package_json(startPath) {
    if (!startPath) {
        throw new errors_1.ZephyrError(errors_1.ZeErrors.ERR_PACKAGE_JSON_NOT_FOUND);
    }
    let retry = 0;
    let dir = startPath;
    do {
        retry++;
        if (retry > max_retry) {
            throw new errors_1.ZephyrError(errors_1.ZeErrors.ERR_PACKAGE_JSON_NOT_FOUND);
        }
        const packageJsonPath = (0, node_path_1.join)(dir, 'package.json');
        try {
            (0, node_fs_1.accessSync)(packageJsonPath, promises_1.constants.F_OK);
            return {
                path: packageJsonPath,
                json: await (0, promises_1.readFile)(packageJsonPath, 'utf8'),
            };
        }
        catch (e) {
            debug_1.ze_log.package(e);
        }
        const parentDir = (0, node_path_1.resolve)(dir, '..');
        if (parentDir === dir) {
            throw new errors_1.ZephyrError(errors_1.ZeErrors.ERR_PACKAGE_JSON_NOT_FOUND);
        }
        dir = parentDir;
    } while (startPath !== dir);
    throw new errors_1.ZephyrError(errors_1.ZeErrors.ERR_PACKAGE_JSON_NOT_FOUND);
}
//# sourceMappingURL=find-nearest-package-json.js.map